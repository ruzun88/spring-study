# 싱글톤 컨테이너
## 웹 Application과 싱글톤
- 스프링은 웹 어플리케이션 제작이 주 목적임
- 웹 어플리케이션은 여러 고객이 동시에 요청이 들어온다.
- 요청이 올 때마다 new를 하여 새 객체를 만든다면? Hell
- 배민 최대 5만 tps인데 그러면 5만개의 객체가 1초에 생성이 되어야 한다!
- 비효율적이므로 생성된 객체를 공유해서 사용한다.

## 싱글톤 패턴
- 클래스의 인스턴스가 딱 1개만 생성되는 것을 보장하는 디자인 패턴이다.
- 객체 인스턴스를 2개 이상 생성하지 못하도록 막아야 한다.
- 객체 하나를 효율적으로 쓸 수 있다.
### 단점
- 싱글톤 패턴 구현을 위한 코드 자체가 많이 들어간다.
- DIP 위반 (instance를 직접 호출해야 한다.)
- 테스트하기 어렵다.
- 내부 속성 변경이나 초기화하기 어렵다.
- private 생성자를 사용하기 때문에 자식 클래스 만들기가 어렵다.
- 유연성이 떨어진다.
- 안티패턴으로 불리기도 한다.

## 싱글톤 컨테이너
- 싱글톤 패턴의 단점을 보완해주면서 객체 인스턴스를 싱클톤으로 관리한다.
- 스프링 컨테이너는 싱글톤 컨테이너 역할을 함
- 싱글톤 객체를 생성하고 관리하는 기능을 싱글톤 레지스트리라 함
- 과거 싱글톤 패턴의 단점을 보완함
  - 추가 코드 필요하지 않음
  - DIP, OCP, private 생성자의 문제점에서 벗어남

## 싱글톤 방식의 주의점
- 여러 클라이언트가 같은 인스턴스를 공유하기 때문에, 싱글톤 객체는 stateful하게 설계하면 안된다.
- 무상태(stateless)로 설계해야 한다.
  - 특정 클라이언트가 값을 변경할 수 있는 필드가 있으면 안된다!
  - 가급적 읽기만 가능해야 한다.
  - 필드 대신 자바에서 공유되지 않는 지역변수, 파라미터, ThreadLocal을 사용해야 한다.
- 공유값 설정 시, 정말 큰 장애가 발생할 수 있다.

## @Configuration과 싱글톤
- AppConfig.java에서 각 Bean이 생성될 때, memberRepository는 new로 생성되는 것 처럼 보인다!
- but, 모두 동일한 instance이다.

## @Configuration과 바이트코드 조작의 마법
- 생성된 Bean의 클래스를 찍어보면 xxxCGLIB이 붙은 것이 나온다  
  ex) hello.core.AppConfig$$EnhancerBySpringCGLIB$$8d524624
- @Bean이 붙은 메서드 마다 이미 스프링 빈이 존재하면 존재하는 빈 반환, 그렇지 않으면 생성해서 스프링 빈으로 등록하고 반환하는 코드가 동적으로 만들어 짐
- 덕분에 singleton 보장이 됨

### @Configuration을 붙이지 않고, @Bean만 쓴다면?
- CGLIB 기술을 사용하지 않으므로 `싱글톤 보장이 안된다`
- Bean으로 등록은 되긴 한다.

`스프링 설정 정보는 항상 @Configuration`을 등록한다.